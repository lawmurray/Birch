version: 2.1

orbs:
  codecov: codecov/codecov@3.2.5

executors:
  bench:
    machine:
      image: ubuntu-2204:current
    resource_class: large
    environment:
      CODENAME: bench
      OMP_NUM_THREADS: 4
      CXXFLAGS: -O3 -flto -march=native -Wall
      MAKEFLAGS: -j8
      CONFIGURE_FLAGS: --disable-assert
      BIRCH_FLAGS: --unit=dir --arch=native --jobs=8 --enable-verbose --disable-assert --disable-debug --disable-static --disable-single
      MONGODB_DATABASE_TOOLS_URL: https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2204-x86_64-100.7.0.deb
    working_directory: /home/circleci/bench

  cover:
    machine:
      image: ubuntu-2204:current
    resource_class: large
    environment:
      CODENAME: cover
      OMP_NUM_THREADS: 4
      CXXFLAGS: -O1 -Wall -g -fno-inline --coverage
      MAKEFLAGS: -j8
      BIRCH_FLAGS: --unit=dir --jobs=3 --enable-verbose --disable-optimize --disable-static --disable-single --enable-coverage
    working_directory: /home/circleci/cover

  mac:
    macos:
      xcode: 14.2.0
    resource_class: macos.x86.medium.gen2
    environment:
      CODENAME: mac
      OMP_NUM_THREADS: 4
      CXXFLAGS: -O1 -flto -Wall
      MAKEFLAGS: -j8
      BIRCH_FLAGS: --unit=dir --jobs=4 --enable-verbose --disable-optimize --disable-static --disable-single
    working_directory: /Users/distiller/mac

commands:

  environment:
    steps:
      - run:
          name: Install dependencies
          command: |
              if [ "$CODENAME" = "mac" ]; then
                HOMEBREW_NO_AUTO_UPDATE=1 brew install \
                    gnupg \
                    coreutils \
                    make \
                    autoconf \
                    automake \
                    libtool \
                    flex \
                    bison \
                    libomp \
                    jemalloc \
                    eigen \
                    libyaml \
                    boost \
                    sqlite \
                    cairo
                echo "export PATH=/usr/local/opt/gnu-time/libexec/gnubin:/usr/local/opt/flex/bin:/usr/local/opt/bison/bin:\$PATH" >> $BASH_ENV
              elif [ "$CODENAME" = "bench" ] || [ "$CODENAME" = "cover" ]; then
                sudo apt update
                DEBIAN_FRONTEND=noninteractive sudo apt install -y --no-install-recommends \
                  git \
                  ssh \
                  gpg \
                  gpg-agent \
                  tar \
                  gzip \
                  xz-utils \
                  curl \
                  time \
                  ca-certificates \
                  binutils \
                  elfutils \
                  make \
                  autoconf \
                  automake \
                  libtool \
                  flex \
                  bison \
                  g++ \
                  gdb \
                  lcov \
                  libjemalloc-dev \
                  libeigen3-dev \
                  libyaml-dev \
                  libboost-math-dev \
                  libsqlite3-dev \
                  libcairo2-dev
                if [ -n "$MONGODB_DATABASE_TOOLS_URL" ]; then
                  curl -o mongodb-database-tools.deb $MONGODB_DATABASE_TOOLS_URL
                  DEBIAN_FRONTEND=noninteractive sudo apt install -y ./mongodb-database-tools.deb
                  rm -f mongodb-database-tools.deb
                fi
                sudo rm -rf /var/lib/apt/lists/*
              fi
      - run:
          name: Environment variables
          command: |
              echo "export PATH=\$CIRCLE_WORKING_DIRECTORY/bin:/usr/local/cuda/bin:\$PATH" >> $BASH_ENV
              echo "export CPLUS_INCLUDE_PATH=\$CIRCLE_WORKING_DIRECTORY/include:/usr/local/cuda/include:\$CPLUS_INCLUDE_PATH" >> $BASH_ENV
              echo "export LD_LIBRARY_PATH=\$CIRCLE_WORKING_DIRECTORY/lib64:\$CIRCLE_WORKING_DIRECTORY/lib:/usr/local/cuda/lib64/stubs:/usr/local/cuda/lib/stubs:\$LD_LIBRARY_PATH" >> $BASH_ENV
              echo "export LIBRARY_PATH=\$CIRCLE_WORKING_DIRECTORY/lib64:\$CIRCLE_WORKING_DIRECTORY/lib:/usr/local/cuda/lib64/stubs:/usr/local/cuda/lib/stubs:\$LIBRARY_PATH" >> $BASH_ENV
              echo "export FORMAT=', \"real\": %e, \"user\": %U, \"system\": %S, \"memory\": %M, \"involuntary\": %c, \"voluntary\": %w'" >> $BASH_ENV

  end_if_pull_request:
    steps:
      - run: 
         name: End early if pull request
         command: |
            if [[ -n "$CIRCLE_PR_NUMBER" ]]; then
              circleci step halt
            fi
  codecov:
    steps:
      - run:
          name: Produce coverage report
          command: lcov --directory . --no-external --capture -o cov.info || echo
      - codecov/upload:
          file: cov.info
          when: on_success

  build_cpp:
    description: Build a C++ package
    parameters:
      dir:
        description: Directory containing the package
        type: string
    steps:
      - run:
          name: Build << parameters.dir >>
          command: |
              cd << parameters.dir >>
              ./bootstrap
              ./configure --prefix="$CIRCLE_WORKING_DIRECTORY" $CONFIGURE_FLAGS || (cat config.log && exit 1)
              make install
      - run:
          name: Smoke test << parameters.dir >>
          command: |
            cd << parameters.dir >>
            if [[ -e smoke.sh ]]; then
              ./smoke.sh
            fi

  build_birch:
    description: Build a Birch package
    parameters:
      dir:
        description: Directory containing the package
        type: string
    steps:
      - run:
          name: Build << parameters.dir >>
          command: |
              cd << parameters.dir >>
              birch install --prefix="$CIRCLE_WORKING_DIRECTORY" $BIRCH_FLAGS || (cat config.log && exit 1)
          no_output_timeout: 30m
      - run:
          name: Smoke test << parameters.dir >>
          command: |
              cd << parameters.dir >>
              birch docs
              if [[ -e smoke.sh ]]; then
                ./smoke.sh
              fi
      - run:
          name: Unit test << parameters.dir >>
          command: |
              cd << parameters.dir >>
              if [[ -e test.sh && "$CODENAME" =~ "bench" ]]; then
                env time --format="$FORMAT" --output=time.txt ./test.sh  # env time to use GNU time, not Bash built-in time
                if [[ -e output/test.json && -n "$MONGODB_HOST" && -n "$MONGODB_USERNAME" && -n "$MONGODB_PASSWORD" ]]; then
                  # upload results to MongoDB Atlas
                  VERSION_LONG=`git describe --long || echo`
                  echo '{ "output": ' > mongodb.json
                  cat output/test.json >> mongodb.json
                  if [[ -e time.txt ]]; then
                    cat time.txt >> mongodb.json
                  fi
                  echo ", \"branch\": \"$CIRCLE_BRANCH\"" >> mongodb.json
                  echo ", \"version\": \"$VERSION_LONG\"" >> mongodb.json
                  echo '}' >> mongodb.json
                  COLLECTION=`echo << parameters.dir >> | sed -E 's/^[A-Z0-9a-z]+\///'`
                  mongoimport --uri mongodb+srv://$MONGODB_USERNAME:$MONGODB_PASSWORD@$MONGODB_HOST/test --collection $COLLECTION --file mongodb.json
                fi
              fi

jobs:
  build:
    parameters: 
      os:
        type: string
    executor: << parameters.os >>
    steps:
      - environment
      - checkout
      - build_cpp:
          dir: numbirch
      - build_cpp:
          dir: membirch
      - build_cpp:
          dir: birch
      - build_birch:
          dir: libraries/Standard
      - build_birch:
          dir: libraries/Cairo
      - build_birch:
          dir: libraries/SQLite
      - persist_to_workspace:
          root: ..
          paths:
            - << parameters.os >>
      - end_if_pull_request

  test:
    parameters: 
      os:
        type: string
    executor: << parameters.os >>
    steps:
      - environment
      - attach_workspace:
          at: ..
      - build_birch:
          dir: tests/Test
      - when:
          condition:
            equal: [<< parameters.os >>, cover]
          steps:
            - codecov        
      - end_if_pull_request

  example:
    parameters: 
      os:
        type: string
      dir:
        description: Directory containing the package
        type: string
    executor: << parameters.os >>
    steps:
      - environment
      - attach_workspace:
          at: ..
      - build_birch:
          dir: << parameters.dir >>
      - when:
          condition:
            equal: [<< parameters.os >>, cover]
          steps:
            - codecov        
      - end_if_pull_request

workflows:
  all:
    jobs:
      - build:
          matrix:
            parameters:
              os:
                - bench
                - cover
                - mac

      - test:
          matrix:
            parameters:
              os:
                - bench
                - cover
                - mac
          requires:
            - build-<< matrix.os >>

      - example:
          matrix:
            parameters:
              os:
                - bench
                - cover
                - mac
              dir:
                - examples/Ecology
                - examples/LinearRegression
                - examples/MixedGaussian
                - examples/MultiObjectTracking
                - examples/SIR
                - examples/VectorBorneDisease
          requires:
            - test-<< matrix.os >>
